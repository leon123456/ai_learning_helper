# 试卷批量诊断功能设计文档

## 🎯 功能概述

用户上传一页试卷图片，系统自动切题识别，用户确认/输入答案后，系统批量诊断并生成学习报告。

## 📋 用户流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  1️⃣ 上传试卷图片 (/paper)                                               │
│     └─ 用户拍照或上传试卷图片                                             │
│                    ↓                                                     │
│  2️⃣ AI 自动切题识别                                                     │
│     └─ 调用阿里云 RecognizeEduPaperStructed API                          │
│     └─ 返回题目列表、配图坐标、题型识别                                    │
│                    ↓                                                     │
│  3️⃣ 确认题目和答案 (/paper/review)                                       │
│     └─ 显示识别出的所有题目                                               │
│     └─ 用户输入/确认每道题的答案                                          │
│     └─ 选择题：点击选项；其他题型：输入文字                                │
│                    ↓                                                     │
│  4️⃣ 批量诊断                                                            │
│     └─ 调用后端批量诊断 API                                               │
│     └─ LLM 逐题分析（包含配图信息）                                       │
│                    ↓                                                     │
│  5️⃣ 查看诊断报告 (/paper/result)                                        │
│     └─ 整体正确率、掌握度                                                 │
│     └─ 按题型统计                                                        │
│     └─ 薄弱知识点分析                                                    │
│     └─ 每道题的详细诊断                                                  │
│     └─ 个性化学习建议                                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 📁 新增文件

### 前端

```
ai_learning_web/
├── lib/
│   ├── paper-types.ts    # 类型定义
│   ├── paper-api.ts      # API 函数
│   └── paper-store.ts    # 状态管理
└── app/
    └── paper/
        ├── page.tsx           # 1️⃣ 上传页面
        ├── review/
        │   └── page.tsx       # 3️⃣ 题目确认页面
        └── result/
            └── page.tsx       # 5️⃣ 诊断结果页面
```

### 后端（已实现）

```
learning_diagnosis_backend/
└── app/
    ├── api/v1/
    │   └── routes_paper.py        # API 路由
    ├── services/
    │   ├── aliyun_paper_ocr.py    # 阿里云试卷 OCR
    │   └── paper_diagnostic.py    # 批量诊断服务
    └── schemas/
        └── paper.py               # 数据模型
```

## 🔄 API 调用流程

### 1. 试卷识别 API

**请求：**
```typescript
POST /api/v1/paper/recognize
{
  "image_base64": "..."  // 或 "image_url": "https://..."
}
```

**响应：**
```typescript
{
  "paper_structure": {
    "width": 1068,
    "height": 1146,
    ...
  },
  "questions": [
    {
      "index": 0,
      "type": "choice",
      "question": "题干内容...",
      "options": ["A. xxx", "B. xxx", ...],
      "position": [[{x, y}, ...]],
      "has_figure": true,
      "figure_description": "配图1: 题目配图（位置...）"
    }
  ],
  "total_questions": 6,
  "figures": [...]
}
```

### 2. 批量诊断 API

**请求：**
```typescript
POST /api/v1/paper/batch-diagnose
{
  "questions": [...],  // 来自识别结果
  "answers": [
    { "question_index": 0, "user_answer": "A" },
    { "question_index": 1, "user_answer": "B" },
    { "question_index": 2, "user_answer": "" }  // 未作答
  ]
}
```

**响应：**
```typescript
{
  "results": [
    {
      "question_index": 0,
      "question": {...},
      "diagnose_result": {
        "correct": true,
        "correct_answer": "A",
        "user_answer": "A",
        "error_type": "无",
        "analysis": "解析...",
        "mastery_score": 95,
        "next_action": "建议..."
      }
    }
  ],
  "summary": {
    "total_questions": 6,
    "correct_count": 4,
    "wrong_count": 1,
    "unanswered_count": 1,
    "accuracy": 80.0,
    "average_mastery": 75.5,
    "stats_by_type": {...},
    "weak_knowledge_points": [...],
    "overall_suggestion": "..."
  }
}
```

## 🎨 页面设计

### 1️⃣ 上传页面 (`/paper`)

```
┌──────────────────────────────────────────┐
│              上传试卷                     │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │                                    │  │
│  │      拖拽图片到这里，或点击上传      │  │
│  │                                    │  │
│  │        支持 JPG、PNG、WebP          │  │
│  │                                    │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 智能切题 │ │ 配图识别 │ │ 批量诊断 │   │
│  └─────────┘ └─────────┘ └─────────┘   │
│                                          │
│  💡 拍照建议：确保试卷平整、光线充足...    │
└──────────────────────────────────────────┘
```

### 3️⃣ 题目确认页面 (`/paper/review`)

```
┌──────────────────────────────────────────────────────────────────┐
│  ← 重新上传              确认题目和答案              进度: 4/6   │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────┐  ┌──────────────────────────────────────┐│
│  │                   │  │ 第 1 题 [选择题]            ✅ 已答  ││
│  │                   │  │                                      ││
│  │   试卷原图        │  │ 题干：(1+5i)i的虚部为...              ││
│  │                   │  │                                      ││
│  │                   │  │ ○ A. -1    ● B. 0                   ││
│  │                   │  │ ○ C. 1     ○ D. 6                   ││
│  │                   │  └──────────────────────────────────────┘│
│  │                   │                                          │
│  │                   │  ┌──────────────────────────────────────┐│
│  │                   │  │ 第 2 题 [填空题]            ○ 未答  ││
│  │                   │  │                                      ││
│  │                   │  │ 题干：计算 √2 + √8 = ___            ││
│  │                   │  │                                      ││
│  │                   │  │ 你的答案：[______________]           ││
│  └───────────────────┘  └──────────────────────────────────────┘│
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│              还有 2 道题未作答          [ 提交诊断 ]             │
└──────────────────────────────────────────────────────────────────┘
```

### 5️⃣ 诊断结果页面 (`/paper/result`)

```
┌──────────────────────────────────────────────────────────────────┐
│  ← 返回修改                                      🔄 重新开始     │
├──────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  🎯 诊断报告                              正确率: 80%      │  │
│  │  ──────────────────────────────────────────────────────    │  │
│  │  正确: 4    错误: 1    未作答: 1    平均掌握度: 75%        │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌────────────────────┐ ┌────────────────────────────────────┐  │
│  │ 📊 按题型统计       │ │ ⚠️ 薄弱知识点                      │  │
│  │                    │ │                                    │  │
│  │ 选择题: 75% ████   │ │ • 复数运算 (2/3 错误)              │  │
│  │ 填空题: 100% █████ │ │   建议练习 4 题                    │  │
│  └────────────────────┘ └────────────────────────────────────┘  │
│                                                                  │
│  💡 学习建议：正确率良好，建议重点复习复数相关知识点...          │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 📖 详细诊断结果                                            │  │
│  ├────────────────────────────────────────────────────────────┤  │
│  │ ✅ 第 1 题  掌握度: 95%                              [展开] │  │
│  │ ✅ 第 2 题  掌握度: 90%                              [展开] │  │
│  │ ❌ 第 3 题  掌握度: 40%                              [展开] │  │
│  │ ✅ 第 4 题  掌握度: 85%                              [展开] │  │
│  │ ✅ 第 5 题  掌握度: 80%                              [展开] │  │
│  │ ⚪ 第 6 题  未作答                                   [展开] │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
```

## 💡 关于用户答案的获取

### 当前方案：用户手动输入

**优点：**
- ✅ 简单可靠
- ✅ 用户可以核对题目识别是否正确
- ✅ 适用于空白试卷（练习模式）

**缺点：**
- ⚠️ 需要用户手动输入每道题的答案
- ⚠️ 对于已作答的试卷，需要重新输入

### 未来扩展：OCR 自动识别答案

可以增加"识别答案"功能：
1. 用户上传已作答的试卷
2. 系统尝试识别手写/选择的答案
3. 用户确认或修改识别结果

**实现方式：**
- 使用阿里云 OCR 或 GPT-4 Vision 识别手写内容
- 选择题：识别填涂位置
- 填空题/解答题：识别手写文字

## 🚀 如何运行

### 1. 启动后端

```bash
cd learning_diagnosis_backend
uvicorn app.main:app --reload --port 8000
```

### 2. 启动前端

```bash
cd ai_learning_web
npm run dev
```

### 3. 访问页面

- 试卷上传：http://localhost:3000/paper
- 题目确认：http://localhost:3000/paper/review
- 诊断结果：http://localhost:3000/paper/result

## ⚙️ 配置

### 后端 `.env`

```env
# 阿里云 OCR（必需）
ALIYUN_ACCESS_KEY_ID=...
ALIYUN_ACCESS_KEY_SECRET=...
ALIYUN_OCR_ENDPOINT=cn-hangzhou.aliyuncs.com

# LLM（诊断时使用，选择一个）
PROVIDER=azure  # 或 openai / deepseek / qwen
AZURE_OPENAI_ENDPOINT_GPT4O2=...
AZURE_OPENAI_API_KEY_GPT4O2=...
```

### 前端 `.env.local`

```env
NEXT_PUBLIC_API_URL=http://127.0.0.1:8000
```

## 📊 数据流

```
用户上传图片
    ↓
前端: fileToBase64Raw()
    ↓
API: POST /api/v1/paper/recognize
    ↓
后端: 阿里云 RecognizeEduPaperStructed
    ↓
后端: parse_question_from_aliyun() 关联配图
    ↓
返回: questions[], figures[]
    ↓
前端: 显示题目列表
    ↓
用户: 输入/确认答案
    ↓
API: POST /api/v1/paper/batch-diagnose
    ↓
后端: 逐题调用 DiagnosticEngine
    ↓
后端: LLM 分析（含配图描述）
    ↓
后端: 生成诊断摘要
    ↓
返回: results[], summary
    ↓
前端: 显示诊断报告
```

## ✅ 功能清单

- [x] 试卷上传页面
- [x] 阿里云切题识别
- [x] 题目列表展示
- [x] 用户答案输入（选择题/填空题）
- [x] 配图信息传递给 LLM
- [x] 批量诊断
- [x] 诊断报告页面
- [x] 整体统计
- [x] 按题型统计
- [x] 薄弱知识点分析
- [x] 学习建议
- [x] 每题详细诊断
- [ ] 原图题目高亮（待实现）
- [ ] OCR 自动识别答案（待实现）
- [ ] 错题本功能（待实现）
- [ ] 历史记录（待实现）

## 🎉 总结

这个流程设计是合理的：

1. **用户拍照上传** → 简单直观
2. **AI 自动切题** → 省去手动分割的麻烦
3. **用户确认答案** → 确保答案准确
4. **批量诊断** → 一次性获得完整反馈
5. **学习报告** → 清晰了解掌握情况

整个流程形成闭环，用户可以：
- 了解整体正确率
- 发现薄弱知识点
- 获得针对性学习建议
- 查看每道题的详细解析

