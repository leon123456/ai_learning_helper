# 试卷结构化识别与批量诊断功能说明

## 📋 功能概述

系统新增了**试卷结构化识别**和**批量诊断**功能，允许用户上传整张试卷或练习册图片，系统自动切题、识别内容、批量诊断，并生成详细的学习报告。

### 核心能力

1. **智能切题** - 自动识别试卷中的所有题目，无需手动分割
2. **结构化识别** - 自动识别题干、选项、公式、图形
3. **坐标定位** - 返回每道题的位置坐标，支持前端高亮显示
4. **批量诊断** - 一次性诊断整张试卷的所有题目
5. **智能报告** - 生成包含正确率、掌握度、薄弱知识点的诊断报告

## 🏗️ 技术架构

### 使用的阿里云 API

**RecognizeEduPaperStructed**（精细版结构化识别）

- API 文档: https://help.aliyun.com/zh/ocr/developer-reference/api-ocr-api-2021-07-07-recognizeedupaperstructed
- 适用场景：整页试卷、练习册、教辅材料
- 核心功能：
  - ✅ 自动切题（题号识别准确）
  - ✅ 自动结构化题干、选项、公式
  - ✅ 返回题目坐标（可前端高亮）
  - ✅ 支持数学公式 OCR
  - ✅ 支持题目内部图片坐标抽取

### 系统架构

```
用户上传试卷图片
    ↓
阿里云 RecognizeEduPaperStructed API
    ↓
结构化数据解析（切题、题干、选项）
    ↓
标准化题目格式转换
    ↓
用户作答
    ↓
批量调用单题诊断服务
    ↓
生成整体诊断报告
```

## 📁 新增文件说明

### 1. 后端服务层

#### `app/services/aliyun_paper_ocr.py`
试卷结构化识别服务，封装阿里云 API 调用

**主要功能：**
- `AliyunPaperOCRClient.recognize_paper_structure()` - 调用阿里云 API 识别试卷
- `parse_question_from_aliyun()` - 将阿里云返回数据转换为标准题目格式
- 支持 URL 和 base64 两种图片输入方式

**返回数据结构：**
```python
{
    "page_id": 1,
    "width": 2377,
    "height": 3442,
    "part_info": [  # 大题分区（选择题、填空题等）
        {
            "part_title": "选择题",
            "subject_list": [  # 该大题下的小题
                {
                    "index": 1,
                    "type": 0,  # 0=选择题，1=填空题，2=主观题
                    "text": "完整题目文本",
                    "pos_list": [...],  # 题目坐标
                    "element_list": [...]  # 题干、选项等元素
                }
            ]
        }
    ],
    "figure": [...]  # 题目中的图形坐标
}
```

#### `app/services/paper_diagnostic.py`
试卷批量诊断服务，整合识别和诊断功能

**主要功能：**
- `recognize_and_parse_paper()` - 识别并解析试卷
- `batch_diagnose()` - 批量诊断所有题目
- `_generate_summary()` - 生成诊断摘要报告

### 2. 数据模型层

#### `app/schemas/paper.py`
试卷相关的数据模型定义

**主要模型：**

1. **PaperOCRRequest** - 试卷识别请求
```python
{
    "image_url": "https://example.com/paper.jpg",  # 或使用 image_base64
}
```

2. **PaperOCRResponse** - 试卷识别响应
```python
{
    "paper_structure": {...},  # 原始结构化数据
    "questions": [  # 标准化题目列表
        {
            "index": 1,
            "type": "choice",
            "question": "题干",
            "options": ["A...", "B...", "C...", "D..."],
            "position": [...],  # 坐标
            "section_title": "选择题"
        }
    ],
    "total_questions": 10
}
```

3. **BatchDiagnoseRequest** - 批量诊断请求
```python
{
    "questions": [...],  # 来自识别结果
    "answers": [
        {
            "question_index": 1,
            "user_answer": "A"
        }
    ]
}
```

4. **BatchDiagnoseResponse** - 批量诊断响应
```python
{
    "results": [  # 每道题的诊断结果
        {
            "question_index": 1,
            "question": {...},
            "diagnose_result": {
                "correct": true,
                "correct_answer": "A",
                "user_answer": "A",
                "error_type": "无",
                "analysis": "...",
                "mastery_score": 95,
                "next_action": "...",
                "recommended_practice": [...]
            }
        }
    ],
    "summary": {  # 整体诊断摘要
        "total_questions": 10,
        "answered_questions": 10,
        "correct_count": 8,
        "wrong_count": 2,
        "unanswered_count": 0,
        "accuracy": 80.0,
        "average_mastery": 75.5,
        "stats_by_type": {  # 按题型统计
            "choice": {
                "total": 5,
                "correct": 4,
                "wrong": 1,
                "unanswered": 0,
                "accuracy": 80.0
            }
        },
        "weak_knowledge_points": [  # 薄弱知识点
            {
                "knowledge": "运动学基础",
                "error_count": 2,
                "total_count": 3,
                "accuracy": 33.3,
                "recommended_practice_count": 4
            }
        ],
        "overall_suggestion": "..."
    }
}
```

### 3. API 路由层

#### `app/api/v1/routes_paper.py`
试卷相关的 API 接口

**接口列表：**

1. **POST /api/v1/paper/recognize**
   - 功能：试卷结构化识别
   - 输入：试卷图片（URL 或 base64）
   - 输出：题目列表 + 坐标信息

2. **POST /api/v1/paper/batch-diagnose**
   - 功能：批量诊断
   - 输入：题目列表 + 用户答案
   - 输出：每题诊断结果 + 整体报告

### 4. 测试脚本

#### `test/test_paper_ocr.py`
试卷识别和批量诊断的测试脚本

**使用方式：**
```bash
# 仅测试试卷识别
python test/test_paper_ocr.py

# 测试试卷识别 + 批量诊断
python test/test_paper_ocr.py --with-diagnose

# 使用自定义图片
python test/test_paper_ocr.py --image-url "https://your-image-url.com/paper.jpg"
```

## 🚀 使用流程

### 1. 试卷识别

**请求示例（cURL）：**
```bash
curl -X POST "http://localhost:8000/api/v1/paper/recognize" \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "https://example.com/paper.jpg"
  }'
```

**请求示例（Python）：**
```python
import requests

response = requests.post(
    "http://localhost:8000/api/v1/paper/recognize",
    json={
        "image_url": "https://example.com/paper.jpg"
    }
)

data = response.json()
questions = data["questions"]
```

### 2. 用户作答

用户在前端界面查看识别出的题目列表，逐题作答。

### 3. 批量诊断

**请求示例（Python）：**
```python
import requests

# 从识别结果中获取题目列表
questions = [...]  # 来自上一步的识别结果

# 用户答案
answers = [
    {"question_index": 1, "user_answer": "A"},
    {"question_index": 2, "user_answer": "B"},
    {"question_index": 3, "user_answer": ""},  # 未作答
]

# 提交批量诊断
response = requests.post(
    "http://localhost:8000/api/v1/paper/batch-diagnose",
    json={
        "questions": questions,
        "answers": answers
    }
)

result = response.json()
summary = result["summary"]
print(f"正确率: {summary['accuracy']}%")
```

## 📊 诊断报告说明

### 1. 整体指标

- **总题数** - 试卷中识别到的题目总数
- **已作答** - 用户已作答的题目数
- **正确/错误/未作答** - 各种状态的题目数量
- **正确率** - 已作答题目中的正确率
- **平均掌握度** - 所有题目的平均掌握度评分

### 2. 按题型统计

对选择题、填空题、解答题等不同题型分别统计：
- 总数、正确数、错误数、未作答数
- 该题型的正确率

### 3. 薄弱知识点

系统自动识别正确率低于 80% 的知识点，并提供：
- 知识点名称
- 错误次数 / 总题数
- 正确率
- 建议练习题数

### 4. 总体建议

基于诊断结果，系统自动生成学习建议：
- 完成度建议
- 正确率评价
- 掌握度评价
- 针对性学习建议

## ⚙️ 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 阿里云 OCR 配置
ALIYUN_ACCESS_KEY_ID=LTAI5tRm...
ALIYUN_ACCESS_KEY_SECRET=your_secret
ALIYUN_OCR_ENDPOINT=cn-hangzhou.aliyuncs.com

# OCR 提供者（auto | aliyun | llm）
OCR_PROVIDER=auto
```

### RAM 权限要求

确保阿里云 AccessKey 对应的用户拥有以下权限：
- `AliyunOCRFullAccess` 或
- `AliyunOCRReadOnlyAccess`

## 🎯 业务逻辑说明

### 1. 题型识别与转换

阿里云返回的题型与系统内部题型的映射关系：

| 阿里云题型 | type 值 | 系统题型 | 说明 |
|-----------|---------|---------|------|
| 选择题 | 0 | choice | 单选题、多选题 |
| 填空题 | 1 | fill | 填空题 |
| 主观题 | 2 | short_answer / solve / proof | 通过关键词智能判断 |

**智能判断规则：**
- 包含"证明"、"求证"、"试证" → `proof`（证明题）
- 包含"计算"、"求"、"解"、"解答" → `solve`（解答题）
- 其他 → `short_answer`（简答题）

### 2. 未作答检测

系统会检测以下情况，识别为未作答：
- 答案为空字符串或 None
- 答案为纯空白字符
- 答案为常见的未作答标识（"未作答"、"未填写"、"无"、"空"、"null" 等）

未作答题目的特殊处理：
- 不计入正确率统计
- 掌握度为 0
- 错误类型标记为"未作答"
- 提供针对性的作答建议

### 3. 坐标信息用途

每道题返回的 `position` 字段包含题目在原图中的位置坐标，前端可以用于：
- **题目定位** - 点击题目时高亮显示原图中的对应区域
- **拍照上传** - 引导用户对齐拍摄
- **错题回顾** - 查看错题时显示原题图片

坐标格式：
```python
[
    [
        {"x": 170, "y": 417},  # 左上角
        {"x": 1162, "y": 416}, # 右上角
        {"x": 1161, "y": 757}, # 右下角
        {"x": 170, "y": 757}   # 左下角
    ]
]
```

## 🔍 故障排查

### 1. 识别失败

**可能原因：**
- 图片 URL 不可访问
- 阿里云 AccessKey 配置错误
- RAM 权限不足
- 图片格式不支持

**解决方法：**
- 确保图片 URL 公网可访问（推荐使用图床或 OSS）
- 检查 `.env` 中的阿里云配置
- 在阿里云 RAM 控制台添加 OCR 权限
- 支持的图片格式：JPG、PNG、PDF

### 2. 识别结果不准确

**可能原因：**
- 图片清晰度不够
- 题目格式不规范
- 包含手写内容

**建议：**
- 使用高清扫描件或拍照
- 确保试卷格式规范（有清晰的题号）
- 手写内容识别效果可能较差，建议使用打印试卷

### 3. 批量诊断超时

**可能原因：**
- 题目数量太多
- LLM API 响应慢

**解决方法：**
- 分批诊断（建议每批不超过 20 题）
- 检查网络连接和 API 配额

## 📝 开发说明

### 扩展新的题型

如需添加新的题型识别规则，修改 `app/services/aliyun_paper_ocr.py` 中的 `parse_question_from_aliyun()` 函数：

```python
# 智能判断题型（如果是主观题，进一步细分）
if question_type == "short_answer":
    if any(keyword in question_text for keyword in ["你的关键词"]):
        question_type = "your_new_type"
```

### 自定义诊断报告

如需自定义诊断摘要生成逻辑，修改 `app/services/paper_diagnostic.py` 中的 `_generate_summary()` 和 `_generate_overall_suggestion()` 函数。

## 📚 相关文档

- [阿里云 RecognizeEduPaperStructed API 文档](https://help.aliyun.com/zh/ocr/developer-reference/api-ocr-api-2021-07-07-recognizeedupaperstructed)
- [阿里云 RAM 权限配置](https://ram.console.aliyun.com/)
- [单题诊断功能说明](./阿里云OCR测试总结.md)
- [项目整体设计](../../project_design.md)

## ✅ 功能清单

- [x] 试卷结构化识别服务
- [x] 数据模型定义
- [x] 批量诊断服务
- [x] API 接口实现
- [x] 测试脚本
- [x] 文档说明
- [ ] 前端界面（待开发）
- [ ] 题库集成（待开发）
- [ ] 错题本功能（待开发）

## 🎉 总结

通过集成阿里云 RecognizeEduPaperStructed API，系统现在支持：

1. **一键识别整张试卷** - 无需手动切题
2. **智能结构化** - 自动识别题干、选项、公式
3. **批量诊断** - 一次性诊断所有题目
4. **详细报告** - 包含正确率、掌握度、薄弱知识点等多维度分析
5. **前端友好** - 提供题目坐标，支持高亮显示

这大大提升了系统的实用性和用户体验，使其真正具备了处理整张试卷的能力。

